<!DOCTYPE html>
<head>
  <link href="https://vjs.zencdn.net/7.11.4/video-js.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css"> <!-- Custom style -->
  <title>360 Video Demo</title>
  <script src="node_modules/video.js/dist/video.js"></script>
  <script src="node_modules/videojs-vr/dist/videojs-vr.js"></script>    
  <script src="script/three.js"></script>
  <script src='https://unpkg.com/three-mesh-ui'></script>
</head>

<body>
  <div id="container"></div>

  <video id="video" loop muted crossOrigin="anonymous" playsinline style="display:none">
    <source src="360small.mp4" type="video/mp4">
  </video>  

  <script type="module">
    // use /script/VRButton.js for localhost
    // use /360videodemo/script/VRButton.js for github pages
    import {VRButton} from '/360videodemo/script/VRButton.js';

    let camera, scene, renderer;

    init();
    animate();
    makeUI();

    function init() {
        const container = document.getElementById('container');
        container.addEventListener('click', function() {
            video.play();
        });

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 2000);
        camera.layers.enable(1); // render left view when no stereo available

        // Video
        const video = document.getElementById('video');
        video.play();

        const texture = new THREE.VideoTexture(video);

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x101010);

        // Left eye
        const geometry1 = new THREE.SphereGeometry(500, 60, 40);
        // invert the geometry on the x-axis so that all of the faces point inward
        geometry1.scale(-1, 1, 1);

        const uvs1 = geometry1.attributes.uv.array;

        for (let i = 0; i < uvs1.length; i += 2) {
          uvs1[i] *= 0.5;
        }

        const material1 = new THREE.MeshBasicMaterial({map: texture});

        const mesh1 = new THREE.Mesh(geometry1, material1);
        mesh1.rotation.y = - Math.PI / 2;
        mesh1.layers.set(1); // display in left eye only
        scene.add(mesh1);

        // Right eye
        const geometry2 = new THREE.SphereGeometry(500, 60, 40);
        geometry2.scale(-1, 1, 1);

        const uvs2 = geometry2.attributes.uv.array;

        for (let i = 0; i < uvs2.length; i += 2) {
          uvs2[i] *= 0.5;
          uvs2[i] += 0.5;
        }

        const material2 = new THREE.MeshBasicMaterial({map: texture});

        const mesh2 = new THREE.Mesh(geometry2, material2);
        mesh2.rotation.y = - Math.PI / 2;
        mesh2.layers.set(2); // display in right eye only
        scene.add(mesh2);

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType('local');
        container.appendChild(renderer.domElement);

        document.body.appendChild(VRButton.createButton(renderer));

        window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render() {
      ThreeMeshUI.update();
      renderer.render(scene, camera);
    }

    function makeUI() {
      const container = new ThreeMeshUI.Block({
        height: 1,
        width: 2.5
      });
      
      container.position.set(0, 1, -1.8);
      container.rotation.x = -0.55;
      scene.add(container);	

      const menu = new ThreeMeshUI.Block({
        height: 0.6,
        width: 2.5,
        offset: 0,
        alignContent: 'center', 
        justifyContent: 'center', 
        padding: 0.03
      });

      const video = new ThreeMeshUI.Block({
        height: 0.27,
        width: 2,
        margin: 0.05,
        offset: 0
      });

      container.add(menu, video);

      const loader = new THREE.TextureLoader();

      // use /assets/videoplayer.jpg for localhost
      // use /360videodemo/assets/videoplayer.jpg for git
      loader.load('/assets/videoplayer.jpg', (texture)=> {
        video.set({backgroundTexture: texture});
      });

      // use /assets/Roboto-msdf.json for localhost
      // use /360videodemo/assets/Roboto-msdf.json for git
      container.set({
        fontFamily: '/360videodemo/assets/Roboto-msdf.json',
        fontTexture: '/360videodemo/assets/Roboto-msdf.png',
      });
        
      const text = new ThreeMeshUI.Text({
        content: 'transcript    details    clips    share    cite'
      });

      menu.add(text);

      text.set({
        fontColor: new THREE.Color(0xFFFFFF),
        fontSize: 0.1
      });
    }

  </script>
</body>